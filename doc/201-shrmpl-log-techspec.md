# Rust Log Receiver — Technical Specification (v0.4)

> **Purpose:**
> A lightweight, fixed-width, line-based TCP log receiver written in Rust.
> Receives one line per log event, appends directly to daily files for `activity`, `error`, or `misc`.
> Designed for local or trusted networks, no TLS, minimal dependencies, predictable performance.

---

## 1. Overview

- **Transport:** Plain TCP (no TLS).
- **Input:** One log line per TCP send, terminated by `\n`.
- **Output:** Three rotating daily files in a single directory:
  - `activity-YYYYMMDD.log` (for ACTV)
  - `error-YYYYMMDD.log` (for ERRO)
  - `misc-YYYYMMDD.log` (for INFO, DBUG, and any unknown levels)
- **Routing:** Determined by the first four bytes (LVL field).
- **Concurrency:** Listener thread reads and queues records; worker threads write to files.
- **Timestamp:** Generated by the server upon receipt (UTC ISO8601).
- **Optional:** Console echo (DEV_MODE) and periodic stats logging to `misc`.

---

## 2. Wire Protocol

### 2.1 Transport
- **Protocol:** Plain TCP socket (no encryption or authentication).
- **Frame:** One message per line, terminated by `\n` (ASCII LF).
- **No multi-send segmentation:** A single send must include the entire line.
- **Keepalive:** Server sends unsolicited `UPONG <unix_millis>\n` every minute to all connected clients.
- **Idle monitor:** Runs every 60 s; also writes a long stats message into the `misc` file.

### 2.2 Fixed-Width Line Format

Each incoming line has a fixed-width header with spaces, a variable message, and a trailing newline:

[LVL(4)] [HOST(32)] [CODE(4)] [LEN(4)]: [MSG(LEN bytes)]\n

| Field | Width | Description |
|:------|------:|:------------|
| `LVL` | 4 | Log level: `ACTV`, `ERRO`, `DBUG`, `INFO`, etc. Determines destination file. |
| Space | 1 | Separator. |
| `HOST` | 32 | Hostname or device ID. Any ASCII; right-padded or truncated to 32 bytes. |
| Space | 1 | Separator. |
| `CODE` | 4 | Application-defined 4-byte log code (e.g., `G500`, `ABCD`, or `----`). |
| Space | 1 | Separator. |
| `LEN` | 4 | ASCII decimal, zero-padded (`0000`–`4096`). Message length in bytes. |
| `:` | 1 | Literal colon for readability. |
| Space | 1 | Single space before message text. |
| `MSG` | variable (≤4096) | Raw message bytes (client escapes newlines as `\n` if needed). |
| `\n` | 1 | Line terminator. |

**Total header length:** 4 + 1 + 32 + 1 + 4 + 1 + 4 + 1 + 1 = 49 bytes before the message.

**Validation rules**
- Total line length must not exceed `LEN` + header length (49 + LEN bytes).
- Total length ≥ header + 1 + LF.
- `LVL` = 4 ASCII bytes.
- `LEN` must parse 0–4096; lines with invalid or oversize `LEN` are dropped.
- Last character of message must be \n.
- Validity is checked only before enqueueing; no further checks after entering the write queue.

**Routing**
- `LVL=="ACTV"` → `activity-YYYYMMDD.log`
- `LVL=="ERRO"` → `error-YYYYMMDD.log`
- Anything else → `misc-YYYYMMDD.log`


## 3. File Output

### 3.1 On-Disk Format
Each line is written exactly as received, except the server prepends its own UTC timestamp:
[TS(24)] [LVL(4)] [HOST(32)] [CODE(4)] [LEN(4)]: [MSG]\n

example:
```
2025-10-26T14:08:59.041Z ERRO web-02.example.local          G500 0042: Timeout accessing gateway id=gw-7 after 10s
```


### 3.2 File Naming
All files live in one directory:

```
DATA_DIR/
  activity-YYYYMMDD.log
  error-YYYYMMDD.log
  misc-YYYYMMDD.log
```

### 3.3 Rotation
- New files created at UTC midnight (system clock).
- Old files closed and flushed; new files opened automatically.
- No size-based rotation.
- Rotation failure: log error and skip rotation (no retries).

### 3.4 Writing Policy
- Buffered appends.
- Flush to disk every couple seconds (e.g., 2 seconds).
- Atomic append order per file guaranteed by single writer thread per category.

---

## 4. Backpressure and Concurrency

- **Queue:** Single bounded MPSC queue shared by connection threads.
- **Workers:** Three blocking writer threads, each responsible for one file (activity/error/misc).
- **Capacity:** `QUEUE_CAPACITY` (default = 10 000).
- **Policy:**
  - If queue full, drop message and increment drop counter.
- **Thread Safety:** Each writer serializes its own file; no locks between categories.

---

## 5. Keepalive and Idle Monitor

- Every 60 seconds, the server:
  1. Sends `UPONG <unix_millis>\n` to each connected client (ignore errors).
  2. Writes a detailed stats line to `misc-YYYYMMDD.log`, formatted like:
      ```
      2025-10-26T14:10:00.000Z INFO server.local                  STAT 0033: recv=12345 dropped=0 uptime=1.53h
      ```
- Stats counters: total received, dropped, oversize drops, written per file, uptime in hours (to 2 decimal places).

---

## 6. Configuration File

### 6.1 Format
Flat text; each line `KEY=value`.
`#` starts a comment.
Keys are uppercase with underscores.
Values can contain spaces; the value is everything after `=` until the end of the line.

### 6.2 Required

DATA_DIR=/var/log/mylogs
BIND_ADDR=0.0.0.0:7379

### 6.3 Optional

DEV_MODE=true                # mirror writes to stdout and print periodic stats
QUEUE_CAPACITY=10000         # default 10000
KEEPALIVE_STAT_SECS=60            # default 60

---

## 7. Runtime Behavior

| Signal | Action |
|:-------|:--------|
| `SIGUSR1` | Print counters to stdout (even in daemon mode). |
| `SIGHUP`  | Re-read config for DEV_MODE toggle (optional). |

In `DEV_MODE=true`:
- Each accepted line is echoed to stdout with line feeds displayed (unescaping \n to actual newlines).
- Every 60 seconds, stats are printed to console as in the idle monitor log entry.

---

## 8. Error Handling

| Error | Behavior |
|:------|:----------|
| Malformed header / bad LEN | Drop line, increment `protocol_errors_total`. |
| Oversize (`LEN > 4096` or total length > LEN + 49) | Drop line, increment `oversize_drops_total`. |
| Queue full | Drop and increment `dropped_total`. |
| File write error | Log to stderr (DEV_MODE) and retry reopen. |
| Rotation failure | Just die and print error to console, nothing else you can do|

---

## 9. Implementation Details (Rust)

- **Networking:** `tokio::net::TcpListener`, one async task per connection.
- **Reading:**
  - Use fixed buffer `HEADER_BYTES + 1 + MAX_MESSAGE_BYTES + 1`.
  - Read until `\n`.
  - Validate header bytes; copy to owned buffer; enqueue record.
- **Data structure:**
  ```rust
  struct Record {
      lvl: [u8;4],
      host: [u8;32],
      code: [u8;4],
      len: u16,
      msg: Vec<u8>,
      recv_ts: [u8;24], // server timestamp as bytes
  }


  •	Writers: Dedicated threads use BufWriter<File>; flush & fdatasync periodically.
	•	Rotation: Compare current date each write; if changed → rotate files.
	•	Idle monitor: tokio::time::interval(60s) → send UPONG, log stats to misc.

  Dependencies (minimal):
	•	tokio (async net + time)
	•	crossbeam-channel (MPSC queue)
	•	chrono (UTC timestamp formatting)
	•	No JSON, no compression, no TLS.

  ⸻

  10. Testing Plan
1.	Happy path: Valid lines at 10× target throughput; verify all 3 files.
2.	Boundary tests: LEN=0000, LEN=4096.
3.	Malformed lines: missing newline, invalid LEN, short headers.
4.	Burst tests: exceed queue capacity; confirm drop metrics.
5.	Midnight rotation: simulate clock jump; verify new filenames.
6.	Idle monitor: confirm UPONG sent and stats written.
7.	DEV_MODE: visual inspection of stdout mirroring and stats printouts.

  ⸻

  11. Example

Client send (pseudo):
```
ERRO web-02.example.local          G500 0042: Timeout accessing gateway id=gw-7 after 10s\n
```

Server writes:
```
2025-10-26T14:08:59.041Z ERRO web-02.example.local          G500 0042: Timeout accessing gateway id=gw-7 after 10s
```

	Server emits (after 60 s idle):
	```
	UPONG 1735246529999\n
	```

	Server logs stats line in misc-20251026.log:
	```
	2025-10-26T14:10:00.000Z INFOserver.local                  STAT0000: recv=12345 dropped=0 oversize=0 activity_written=100 error_written=200 misc_written=300 uptime=1.00h
	```


	12. Follow-ups / Open Questions
		1.	Confirm that the 60-second stats log interval should match the keepalive cadence. Yes.
		2.	Confirm DEV_MODE printing frequency (default 5 s). no 60
		3.	Confirm that HOST can include any ASCII (no filtering). Yes.
		4.	Confirm no need for size rotation, only midnight rollover. Yes.
		5.	Confirm colon remains as field separator before message. Yes.
