#!/bin/bash

set -e

echo "Building Docker image for Linux cross-compilation..."

# Get project directory (parent of bin)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Build Docker image
docker build -t shrmpl-linux-builder -f "$PROJECT_DIR/etc/Dockerfile" "$PROJECT_DIR/etc"

# Create dist directories
mkdir -p "$PROJECT_DIR/dist/linux"

# Run container to build
echo "Running build in Docker container..."
docker run --rm \
  -v "$PROJECT_DIR:/workspace" \
  -w /workspace \
  shrmpl-linux-builder \
  bash -c "
    echo 'Adding Rust target for Linux...' &&
    rustup target add x86_64-unknown-linux-gnu &&
    export CC=x86_64-linux-gnu-gcc &&
    export CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER=x86_64-linux-gnu-gcc &&
    echo 'Building all binaries for Linux (x86_64-unknown-linux-gnu)...' &&
    cargo build --release --target x86_64-unknown-linux-gnu --bins &&
    cp target/x86_64-unknown-linux-gnu/release/shrmpl-kv-srv /workspace/dist/linux/ &&
    cp target/x86_64-unknown-linux-gnu/release/shrmpl-kv-cli /workspace/dist/linux/ &&
    cp target/x86_64-unknown-linux-gnu/release/shrmpl-log-srv /workspace/dist/linux/ &&
    cp target/x86_64-unknown-linux-gnu/release/shrmpl-vault-srv /workspace/dist/linux/ &&
    cp target/x86_64-unknown-linux-gnu/release/shrmpl-vault-cli /workspace/dist/linux/ &&
    echo 'Build complete. Binaries in /workspace/dist/linux'
  "

echo "Linux build complete. Binaries in dist/linux"